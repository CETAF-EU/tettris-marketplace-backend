name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOCKERHUB_REPOSITORY: ${{ secrets.DOCCKERHUB_REPO }}
  DOCKER_IMAGE_TAG: ${{ github.sha }}
  VITE_ORCID_CLIENT_ID: ${{ secrets.VITE_ORCID_CLIENT_ID }}
  VITE_ORCID_CLIENT_SECRET: ${{ secrets.VITE_ORCID_CLIENT_SECRET }}
  VITE_IMAGE_API: ${{ secrets.VITE_IMAGE_API }}
  VITE_ORCID_REDIRECT_URI: https://marketplace.cetaf.org/te/registerYourExpertise
  
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image backend
      run: |
        docker build \
          --build-arg VITE_ORCID_CLIENT_ID=${{ env.VITE_ORCID_CLIENT_ID }} \
          --build-arg VITE_ORCID_CLIENT_SECRET=${{ env.VITE_ORCID_CLIENT_SECRET }} \
          --build-arg VITE_ORCID_REDIRECT_URI=${{ env.VITE_ORCID_REDIRECT_URI }} \
          --build-arg VITE_IMAGE_API=${{ env.VITE_IMAGE_API }} \
          -f backend/Dockerfile \
          -t ${{ env.DOCKERHUB_REPOSITORY }}:backend-${{ env.DOCKER_IMAGE_TAG }} .

    - name: Tag Docker image with 'backend'        
      run: |
        docker tag ${{ env.DOCKERHUB_REPOSITORY }}:backend-${{ env.DOCKER_IMAGE_TAG }} \
          ${{ env.DOCKERHUB_REPOSITORY }}:backend

    - name: Push Docker images to Docker Hub
      run: |
        docker push ${{ env.DOCKERHUB_REPOSITORY }}:backend-${{ env.DOCKER_IMAGE_TAG }}
        docker push ${{ env.DOCKERHUB_REPOSITORY }}:backend
